<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’§ Ripple</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <style>
        /* A few custom tweaks */
        body {
            padding-top: 2rem;
        }
        .container {
            max-width: 800px;
        }
        #app-container, #auth-container {
            display: none; /* Hide containers by default */
        }
        .visible {
            display: block;
        }
        .post {
            margin-bottom: 1.5rem;
        }
        .post footer {
            color: var(--pico-secondary);
            font-style: italic;
            font-size: 0.9rem;
        }
        #message-area {
            text-align: center;
            min-height: 24px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1 style="text-align: center;">ðŸ’§ Ripple</h1>
            <p style="text-align: center;">Generate social media posts from any text using AI.</p>
        </header>

        <div id="message-area"></div>

        <div id="auth-container" class="container">
            <article>
                <h2 style="text-align: center;">Login</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" id="loginBtn">Login</button>
                </form>
            </article>
            <article>
                <h2 style="text-align: center;">Register</h2>
                <form id="register-form">
                    <input type="email" id="register-email" placeholder="Email" required>
                    <input type="password" id="register-password" placeholder="Password" required>
                    <button type="submit" id="registerBtn">Register</button>
                </form>
            </article>
        </div>

        <div id="app-container" class="container">
            <textarea id="articleText" placeholder="Paste your article or blog post here..."></textarea>
            <div class="grid">
                <button id="generateBtn">Generate Posts</button>
                <button id="logoutBtn" class="secondary">Logout</button>
            </div>
            <section id="results"></section>
        </div>
    </main>

<script>
    // --- DOM Elements ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const messageArea = document.getElementById('message-area');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const generateBtn = document.getElementById('generateBtn');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    
    // --- Event Listeners ---
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
    generateBtn.addEventListener('click', handleGenerate);
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);

    // --- Core Functions ---

    function checkLoginState() {
        const token = localStorage.getItem('ripple_access_token');
        if (token) {
            authContainer.classList.remove('visible');
            appContainer.classList.add('visible');
        } else {
            authContainer.classList.add('visible');
            appContainer.classList.remove('visible');
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        setButtonLoadingState(loginBtn, true);
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const formData = new URLSearchParams({ username: email, password: password });

        try {
            const response = await fetch('/token', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Login failed. Please check your credentials.');
            
            const data = await response.json();
            localStorage.setItem('ripple_access_token', data.access_token);
            showMessage('Login successful!', 'green');
            checkLoginState();
        } catch (error) {
            showMessage(error.message, 'red');
        } finally {
            setButtonLoadingState(loginBtn, false);
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        setButtonLoadingState(registerBtn, true);
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Registration failed.');
            }
            showMessage('Registration successful! Please log in.', 'green');
            registerForm.reset();
        } catch (error) {
            showMessage(error.message, 'red');
        } finally {
            setButtonLoadingState(registerBtn, false);
        }
    }

    function handleLogout() {
        localStorage.removeItem('ripple_access_token');
        showMessage('You have been logged out.', 'green');
        checkLoginState();
    }

    async function handleGenerate() {
        const text = document.getElementById('articleText').value;
        const token = localStorage.getItem('ripple_access_token');
        const resultsEl = document.getElementById('results');

        if (!text.trim()) {
            alert('Please paste some text into the box.');
            return;
        }
        if (!token) {
            showMessage('You must be logged in to generate posts.', 'red');
            handleLogout();
            return;
        }
        
        // 3. Improved User Feedback
        setButtonLoadingState(generateBtn, true);
        resultsEl.innerHTML = `<article aria-busy="true">Generating your posts, please wait...</article>`;
        
        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ text })
            });

            if (response.status === 401) throw new Error('Your session has expired. Please log in again.');
            if (!response.ok) throw new Error('An error occurred while generating posts.');

            const data = await response.json();
            displayPosts(data.posts);
        } catch (error) {
            resultsEl.innerHTML = '';
            showMessage(error.message, 'red');
            if (error.message.includes('session has expired')) {
                handleLogout();
            }
        } finally {
            setButtonLoadingState(generateBtn, false);
        }
    }

    function displayPosts(posts) {
        const resultsEl = document.getElementById('results');
        resultsEl.innerHTML = '';
        posts.forEach(post => {
            const postArticle = document.createElement('article');
            postArticle.className = 'post';
            
            const platform = `<h3>${post.platform}</h3>`;
            const content = `<p>${post.content}</p>`;
            const hashtags = `<footer>${post.hashtags.map(h => `#${h}`).join(' ')}</footer>`;
            
            postArticle.innerHTML = platform + content + hashtags;
            resultsEl.appendChild(postArticle);
        });
    }

    function showMessage(message, color) {
        messageArea.textContent = message;
        messageArea.style.color = color === 'red' ? 'var(--pico-del-color)' : 'var(--pico-success-color)';
        setTimeout(() => { messageArea.textContent = ''; }, 4000);
    }
    
    function setButtonLoadingState(button, isLoading) {
        button.disabled = isLoading;
        button.setAttribute('aria-busy', isLoading);
    }

    // --- Initial Page Load ---
    checkLoginState();
</script>
</body>
</html>